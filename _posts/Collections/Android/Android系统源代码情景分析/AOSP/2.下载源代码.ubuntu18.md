
操作系統 : Ubuntu18.04
CPU  ： Intel(R) Core(TM)
文件系统 ： NTFS （ntfs本身大小写敏感 ，只是 Windows 系统大小写不敏感）


## 0x00. 个人操作记录不具有参考性

所有的内容都来自 : https://source.android.com/?hl=zh-cn
- 编译 AOSP 的要求 : https://source.android.com/source/requirements?hl=zh-cn
- 搭建编译环境 : https://source.android.com/source/initializing?hl=zh-cn

这里做的只是一个个人操作记录 , 你应该有你自己的操作记录 . 

## 0x01. 事先准备
1. sudo apt-get install git-core gnupg flex bison build-essential zip curl zlib1g-dev libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig

2. 下载&安装 open-JDK-7



## 0x02. [源代码控制工具](https://source.android.com/docs/setup/download?hl=zh-cn#installing-repo)

```
sudo apt install repo 
sudo mv /usr/bin/python /usr/bin/python.bak
sudo ln -s /usr/bin/python3 /usr/bin/python
```

## 0x03. [下载源代码](https://source.android.com/docs/setup/download/downloading?hl=zh-cn)

0. repo 指令参考 : https://source.android.com/docs/setup/create/repo?hl=zh-cn#sync

1. 在当前文件夹初始化一个 repo 客户端 , 拉取的代码放在这个文件夹内 . 
    - 选定 (-b 参数) 分支步骤
       1. [清单信息页面](https://android.googlesource.com/platform/manifest) 
       2. Branches -> [More](https://android.googlesource.com/platform/manifest/+refs)
       3. 选择自己的目标分支 , 这里选择的是 `android-6.0.0_r1`
    - 选定分支方法 二 : https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn#source-code-tags-and-builds
      - 关注 **标记** 列
    ```
    // repo init -u https://android.googlesource.com/platform/manifest -b android-6.0.0_r1
    repo init -u https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/platform/manifest -b android-6.0.0_r1
    我们将 链接 替换为 清华 源
    ```

2. 同步代码
    ```  
    sysctl -n hw.logicalcpu // 查看 Mac 最大 CPU 核心数 ; https://opensource.apple.com/source/xnu/xnu-792.2.4/libkern/libkern/sysctl.h.auto.html


    repo sync -c -j4   // 之所以 4  因为 清华源 压力太大 ， 他们希望我们不要超过 4 个线程
    Fetching: 100% (450/450), done in 2h22m1.294s
    ```
   - 占用磁盘空间 175G
   - 用时 , 2h

## 0x04. 编译 Android 源代码

1. 导入编译指令 : `source build/envsetup.sh`
   - 使用 bash 执行导入动作 . 
2. 开始编译 
     ```
      12:25:34 tom@tom-pc android-6.0.0_r1 → lunch aosp_hammerhead-userdebug
      编译成功后 执行 emulator 一直黑屏
     ```
3. 再重新编译试试
     ```
     06:56:13 tom@tom-pc android-6.0.0_r1 → source build/envsetup.sh 
     06:56:20 tom@tom-pc android-6.0.0_r1 → lunch aosp_x86-eng
     06:56:20 tom@tom-pc android-6.0.0_r1 → make clean
     06:56:20 tom@tom-pc android-6.0.0_r1 → make -j8

      06:56:20 tom@tom-pc android-6.0.0_r1 → emulator
      emulator: WARNING: system partition size adjusted to match image file (1280 MB > 200 MB)

      emulator: WARNING: data partition size adjusted to match image file (550 MB > 200 MB)

      emulator: ERROR: x86 emulation currently requires hardware acceleration!
      Please ensure KVM is properly installed and usable.
      CPU acceleration status: This user doesn't have permissions to use KVM (/dev/kvm).
      
      06:56:20 tom@tom-pc android-6.0.0_r1 → sudo apt install qemu-kvm
      06:56:20 tom@tom-pc android-6.0.0_r1 → sudo adduser tom kvm
      06:56:20 tom@tom-pc android-6.0.0_r1 → sudo chown tom /dev/kvm
      06:56:20 tom@tom-pc android-6.0.0_r1 → emulator               ------------------------------------              success
     ```


## 0x05. 编译完成将编译结果写入虚拟机

不用特殊操作 编译完成后 直接 执行 `emulator` 指令即可

但是当设备重启后再想运行这个模拟器 :
0. `cd aosp_path`
1. `source build/envsetup.sh`
3. `lunch 当时编译的那个版本号其他的没有测试`
    - 我暂时用的这个 : `aosp_x86-eng` 第 23 个选项
4. `emulator`
    - 可以通过 `which emulator` 来查看可执行文件位置

使用指定的编译结果启动虚拟机
```
emulator    \
                    -system      ./out/target/product/hammerhead/system.img  \
                    -ramdisk  ./out/target/product/hammerhead/ramdisk.img  \
                    -data         ./out/target/product/hammerhead/userdata.img
```

## 0x06. 查看源代码

对于 Android6 查看方式还是参照 ：/AOSP/android-6.0.0_r1/development/tools/idegen/README 
之后的版本或许可以这样 ： https://juejin.cn/post/6844903700796801037

__未提前编译 AOSP 源码同步完成后直接操作 idegen 生成 android.ipr 尝试导入源码 , 点击无法跳转__

1. 先make development/tools/idegen/子目录：
    - `mmm development/tools/idegen/` :  `- 构建提供的目录中的所有模块及其依赖项。`
        - 实际上我是分两步的 :
        - `cd development/tools/idegen/`
        - `mm`  : `- 构建当前目录中的所有模块及其依赖项。`
    - 这个会得到idegen.jar，这个jar在第二步中要用到，如果没有这一步，第二步会提示找不到这个jar。

2. 生成项目文件：
    - `development/tools/idegen/idegen.sh`
    - 这一步会利用前面的jar，生成android.ipr等项目文件。
    - 本人只得到了两个文件 : `android.ipr` 和 `android.iml`
	- 这两个文件位于 aosp 根目录

3. 将项目导入到 idea 或者 AndroidStudio
	- 导入的时候选择 `android.ipr` 父目录(AOSP 目录)即可
    - 或者导入的时候选择 `android.ipr` 文件即可


__IDEA 配置修改__

androidStudio version :  Android Studio Flamingo | 2022.2.1 Patch 2

如果 时间太久(2023.06.28) 还是应该参照官方指导做出合适的配置 `aosp/development/tools/idegen/README`


个人配置如下 :
```
//Help -> Edit custom properties

# 支持文件数
idea.max.intellisense.filesize=100000
# 支持大小写
idea.case.sensitive.fs=true
```

```
//Help > Edit Custom VM

-Xms1g
-Xmx5g
```
    

__如果 Android studio `update index` 时间太久__
- 可以试着排除这些文件/文件夹
- [right click dir --> "Mark directory as" --> "Excluded"](https://stackoverflow.com/a/62116941)
-  android.iml 文件中注释掉 `isTestSource=true` 的 `sourceFolder`
- 代码自动跳转到 jar 就注释掉 ` android.iml` 中  相应的 jar `orderEntry`

## 错误 一

```
01:09:02 tom@tom-pc android-6.0.0_r1 → source build/envsetup.sh 

01:09:04 tom@tom-pc android-6.0.0_r1 → lunch aosp_x86_64-eng 

============================================

01:09:04 tom@tom-pc android-6.0.0_r1 → m
make: 进入目录“/media/tom/vm/AOSP/android-6.0.0_r1”

============================================
  File "build/tools/findleaves.py", line 95
    print r
          ^
SyntaxError: Missing parentheses in call to 'print'. Did you mean print(r)?
Checking build tools versions...
************************************************************
You are attempting to build with the incorrect version
of java.
 
Your version is: openjdk version "1.7.0_75" OpenJDK Runtime Environment (build 1.7.0_75-b13) OpenJDK 64-Bit Server VM (build 24.75-b04, mixed mode).
The required version is: "1.7.x"
 
Please follow the machine setup instructions at
    https://source.android.com/source/initializing.html
************************************************************
build/core/main.mk:171: *** stop。 停止。
make: 离开目录“/media/tom/vm/AOSP/android-6.0.0_r1”

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 上面有两个问题 ， python 版本问题导致的错误通过修改 python 版本修正
   - 修改 python 版本为 2.x 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
   jdk 版本问题 
  Ubuntu 18 下载不到 open-jdk-7 了， 手动下载压缩包解压并设置环境变量 ， 也不可用
  我们下载 open-jdk-8 替代
   - 下载 open-JDK-8
   -  export EXPERIMENTAL_USE_JAVA8=true
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
```

## 错误 二
```
Lex: aidl <= frameworks/base/tools/aidl/aidl_language_l.l
flex-2.5.39: loadlocale.c:130:_nl_intern_locale_data: ?? 'cnt < (sizeof (_nl_value_type_LC_TIME) / sizeof (_nl_value_type_LC_TIME[0]))' ???
build/core/binary.mk:646: recipe for target 'out/host/linux-x86/obj/EXECUTABLES/aidl_intermediates/aidl_language_l.cpp' failed
make: *** [out/host/linux-x86/obj/EXECUTABLES/aidl_intermediates/aidl_language_l.cpp] 已放弃 (core dumped)
```

export LC_ALL=C

1. https://stackoverflow.com/a/50005120


## 错误 三
```
clang: error: linker command failed with exit code 1 (use -v to see invocation)
build/core/host_shared_library_internal.mk:51: recipe for target 'out/host/linux-x86/obj/lib/libart.so' failed
make: *** [out/host/linux-x86/obj/lib/libart.so] Error 1
```

修改文件 art/build/Android.common_build.mk
```
# Host.
ART_HOST_CLANG := false
ifneq ($(WITHOUT_HOST_CLANG),true)
  # By default, host builds use clang for better warnings.
  # ART_HOST_CLANG := true    # 旧代码
  ART_HOST_CLANG := false       # 新代码
endif
```

## 错误 四

```
/tmp/ccvV5XPY.s: Assembler messages:
/tmp/ccvV5XPY.s:477472: Error: unknown pseudo-op: `.uleb12800x137'
build/core/binary.mk:706: recipe for target 'out/host/linux-x86/obj32/SHARED_LIBRARIES/libart-compiler_intermediates/dex/quick/quick_compiler.o' failed
make: *** [out/host/linux-x86/obj32/SHARED_LIBRARIES/libart-compiler_intermediates/dex/quick/quick_compiler.o] Error 1
```

`make clobber`  此次编译之前没有作清理动作 ， 清理下重新编译 ， 看起来效果不错 。 

```
lunch  aosp_x86_64-eng
make clobber
make -j8
---------------------------------------------------------
Please submit a full bug report,
with preprocessed source if appropriate.
See <http://gcc.gnu.org/bugs.html> for instructions.
build/core/binary.mk:706: recipe for target 'out/host/linux-x86/obj32/SHARED_LIBRARIES/libart-compiler_intermediates/utils/x86_64/assembler_x86_64.o' failed
make: *** [out/host/linux-x86/obj32/SHARED_LIBRARIES/libart-compiler_intermediates/utils/x86_64/assembler_x86_64.o] Error 1
make: *** Waiting for unfinished jobs....
```

```
我们再试一次 
-------------------------------------------
lunch  aosp_hammerhead-userdebug
make clobber
make -j8
============================================
PLATFORM_VERSION_CODENAME=REL
PLATFORM_VERSION=6.0
TARGET_PRODUCT=aosp_hammerhead
TARGET_BUILD_VARIANT=userdebug
TARGET_BUILD_TYPE=release
TARGET_BUILD_APPS=
TARGET_ARCH=arm
TARGET_ARCH_VARIANT=armv7-a-neon
TARGET_CPU_VARIANT=krait
TARGET_2ND_ARCH=
TARGET_2ND_ARCH_VARIANT=
TARGET_2ND_CPU_VARIANT=
HOST_ARCH=x86_64
HOST_OS=linux
HOST_OS_EXTRA=Linux-5.4.0-150-generic-x86_64-with-Ubuntu-18.04-bionic
HOST_BUILD_TYPE=release
BUILD_ID=MRA58K
OUT_DIR=out
============================================

#### make completed successfully (05:46:22 (hh:mm:ss)) ####

```

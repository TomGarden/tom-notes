# 断网和网络异常检测

我们主要考虑的是网络异常所造成的风险。
什么是网络异常？
- 我们所担心的是用户断网后使用了一个被监听了的网络。
- 如果是这样的话，我们可以判断当前网络是否处于被监听状态吗？
    - 网络监听 
        - netfilter
        - 找个开源的路由器 然后修改一下
        - 软路由
        - 这个很essy啊！你直接吧路由器的dns设置成你自定义的dns，然后通过你那边自定义修改或者溴探 
        - 使用ARP包欺骗目的主机，将路由地址指向自己，然后在自己的主机上修改/转发目的主机发过来的数据包。 
        - 最简单的方法就是 路由上/防火墙  设置策略 URL IP  跳转 
        - Linux 有个 IP  Table 
        - 如果你的路由器是基于Linux系统，用netfilter就可以很容易办到。你需要做的就是写两个netfilter内核模块，一个match模块用于匹配指定的网站URL，一个target模块用于修改报文。做这些之前你得熟悉内核netfilter的实现，并且对IP，TCP和HTTP协议都有较深入的理解，最好是看过相关的RFC文档，比如明白修改TCP报文后需要重新计算checksum、TCP的seqence number要根据修改后的报文长度进行修改、甚至需要对http服务器端发TCP reset断开连接而由路由器对内网伪装成http服务器（类似于黑客技术里面的中间人攻击）等等。我以前做过类似模块，不过出于商业原因不能将代码开放出来，不过我记得CU论坛的内核源码版以前有人问过类似的问题，你可以去CU论坛找找看，相较于CSDN论坛CU在Linux方面更专业、大牛也更多。     
- 上述这些网络监听的技术手段都不是客户端可以察觉到的手段，所以客户端本身无法认证这种风险。        

我们可以从别的角度做这个事情吗？
- 如果浅一点的话我们只监听网络的连接状态？然后交给用户判断网络环境？
    - 但是用户怎么会有这种能力呢？

现在没有找到突破口的情况下这个点，看似需要讨论了。

## 上述观点整理
### 先假设断网和网络异常是风险
在面对这个风险的情况下，作为应用开发商能做什么呢？
1. 提示用户可能存在风险。
    - 这就是说要把处理这件事情的责任抛给用户，但是我们怎么能期望用户具备这种知识储备呢?
2. 通过技术手段探测当前网络环境是否存在风险？
    - 这就需要我们了解存在哪些风险网络环境，以及作为客户端如何检测到这些风险网络环境。
    - 已经了解到的风险的网络环境
        - 客户端上层网络环境(路由器/交换机)被监听——很明显在这种情况下作为客户端没能力探测到风险
        - 客户端自身被监听(代理)——然而关于代理环境的检测点已经存在了

写到这里我认为上述假设不成立。

## 讨论之后
- 就是要把风险抛给用户。
- 作为客户端也不能做什么别的了。
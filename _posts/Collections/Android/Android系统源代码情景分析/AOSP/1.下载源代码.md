
## 0x00. 个人操作记录不具有参考性

所有的内容都来自 : https://source.android.com/?hl=zh-cn
- 编译 AOSP 的要求 : https://source.android.com/source/requirements?hl=zh-cn
- 搭建编译环境 : https://source.android.com/source/initializing?hl=zh-cn

这里做的只是一个个人操作记录 , 你应该有你自己的操作记录 . 

## 0x01. 事先准备
1. 对于 MacOS 需要区分大小写的文件系统 . 
2. 安装 Xcode 命令行工具： `xcode-select --install`
3. 安装 MacPorts
4. 通过 MacPorts 获取 Make、Git 和 GPG 程序包：
   ```
   POSIXLY_CORRECT=1 sudo port install gmake libsdl git gnupg bison
   brew install gnupg ccache
   ```
5. 设置文件描述符上限
   ```
    # set the number of open files to be 1024
    ulimit -S -n 1024
   ```
6. 开启编译缓存
   ```
    # 开启编译缓存 , 可以加快多次编译的编译速度 : 
    # https://source.android.com/source/initializing?hl=zh-cn#optimizing-a-build-environment
    export USE_CCACHE=1
    export CCACHE_DIR=/../AOSP/aosp_android-6.0.0_r1/.ccache
    ccache -M 100G
   ```
7. `/usr/sbin/softwareupdate --install-rosetta`

## 0x02. [源代码控制工具](https://source.android.com/docs/setup/download?hl=zh-cn#installing-repo)

使用 MacPorts 包管理工具 : `sudo port install repo `

## 0x03. [下载源代码](https://source.android.com/docs/setup/download/downloading?hl=zh-cn)

0. repo 指令参考 : https://source.android.com/docs/setup/create/repo?hl=zh-cn#sync

1. 在当前文件夹初始化一个 repo 客户端 , 拉取的代码放在这个文件夹内 . 
    - 选定 (-b 参数) 分支步骤
       1. [清单信息页面](https://android.googlesource.com/platform/manifest) 
       2. Branches -> [More](https://android.googlesource.com/platform/manifest/+refs)
       3. 选择自己的目标分支 , 这里选择的是 `android-6.0.0_r1`
    - 选定分支方法 二 : https://source.android.com/docs/setup/about/build-numbers?hl=zh-cn#source-code-tags-and-builds
      - 关注 **标记** 列
    ```
    repo init -u https://android.googlesource.com/platform/manifest -b android-6.0.0_r1

    ```

3. 同步代码
    ```  
    sysctl -n hw.logicalcpu // 查看 Mac 最大 CPU 核心数 ; https://opensource.apple.com/source/xnu/xnu-792.2.4/libkern/libkern/sysctl.h.auto.html

    repo sync -c -j9
    ```
   - 占用磁盘空间 175G
   - 用时 , 2h

## 0x04. 编译 Android 源代码

1. 导入编译指令 : `source build/envsetup.sh`
   - 使用 bash 执行导入动作 . 
2. 开始编译 `lunch aosp_arm-eng`
   - 报错 : 
     ```
     build/core/envsetup.mk:90: *** Unable to determine HOST_ARCH from uname -sm: Darwin arm64!.  Stop.

     ** Don't have a product spec for: 'aosp_arm64'
     ** Do you have the right repo manifest?
     ```